# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта;
- src/components/ — папка с JS компонентами;
- src/components/base/ — папка с базовым кодом;

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы;
- src/scss/styles.scss — корневой файл стилей;
- src/types/index.ts — файл с типами;
- src/utils/constants.ts — файл с константами;
- src/utils/utils.ts — файл с утилитами;
- src/index.ts — точка входа приложения;

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении:

#### Карточка товара:

```ts
export interface IProductItem {
	id: string;
	description: string;
	image: string;
	title: string;
	category: string;
	price: number | null;
}
```

#### Описание представления корзины:

```ts
export interface IBasketView {
	items: HTMLElement[];
	total: number;
}
```

#### Описание данных модального окна:

```ts
export interface IModalData {
	content: HTMLElement;
}
```

#### Интерфейс описания способа оплаты и адреса доставки:

```ts
export interface IDelivery {
	payment: TPaymentMethod;
	address: string;
}
```

#### Интерфейс ввода адреса электронной почты и номера телефона:

```ts
export interface IBuyerContacts {
	email: string;
	phone: string;
}
```

#### Список заказов:

```ts
export interface IOrderList {
	total: number;
	items: string[];
}
```

#### Интерфейс описания успешного заказа:

```ts
export interface IOrderSuccess {
	total: number;
}
```

#### Описание действия для карточки продукта:

```ts
export interface IProductCardActions {
	onClick: (event: MouseEvent) => void;
}
```

#### Описание карточки продукта:

```ts
export interface IProductCard {
	description: string;
	image: string;
	title: string;
	category: string;
	price: number;
	button?: string;
	status: boolean;
}
```

#### Описание элемента корзины:

```ts
export interface IItemProductBasket {
	title: string;
	price: number;
}
```

#### Интерфейс описания страницы:

```ts
export interface IPage {
	counter: number;
	catalog: HTMLElement[];
	locked: boolean;
}
```

#### Интерфейс для состояния формы:

```ts
export interface IFormState {
	valid: boolean;
	errors: string[];
}
```

#### Интерфейс для формы:

```ts
export interface IForm extends IFormState {
	render(data?: IFormState): HTMLElement;
}
```

#### Интерфейс для данных ввода:

```ts
export interface IInputData {
	field: string;
	value: string;
}
```

#### Описание состояния приложения:

```ts
export interface IAppState {
	catalog: IProductItem[];
	basket: string[];
	preview: string | null;
	loading: boolean;
}
```

#### Описание действий при успешном заказе:

```ts
export interface ISuccessActions {
	onClick: () => void;
}
```

#### Интерфейс для работы API. С его помозью мы получаем список товаров, товар и можем оформить заказ:

```ts
export interface IWebLarekApi {
	getProductList: () => Promise<IProductItem[]>;
	getProductItem: (id: string) => Promise<IProductItem>;
	orderProduct: (order: TOrderData) => Promise<IOrderSuccess>;
}
```

#### Данные карточки, используемые при отображении на главной странице:

```ts
export type TProductCard = Omit<IProductItem, 'description'>;
```

#### Выбор способа оплаты: "На сайте" или "При получении":

```ts
export type TPaymentMethod = 'online' | 'upon receipt';
```

#### Тип для данных заказа:

```ts
export type TOrderData = IDelivery & IBuyerContacts & IOrderList;
```

#### Тип записи об ошибке в форме:

```ts
export type FormErrors = Partial<Record<keyof TOrderData, string>>;
```

## Архитектура приложения

Проект основывается на архитектуре **Model-View-Presentor** (MVP) и включает в себя:

- **Model** - слой данных, отвечающая за хранение и обработку информации.
- **View** - слой представления, который отвечает за отображение данных в UI элементах страницы.
- **Presentor** - слой представления, который соединяет модель и отображение.

## Базовый код

### Класс API

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

#### Методы:

- `handleResponse(response: Response): Promise<object>` - обрабатывает ответ с сервера. Если ответ с сервера положительный, то возвращается json, иначе - ошибка.
- `get(uri: string)` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер.
- `post(uri: string, data: object, method: ApiPostMethods = 'POST')` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

### Класс EventEmitter

Брокер событий. Позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.

#### Основные методы, реализуемые классом описаны интерфейсом `IEvents`:

- `on<T extends object>(eventName: EventName, callback: (event: T) => void)` - подписка на событие.
- `off(eventName: EventName, callback: Subscriber)` - отписка от события.
- `emit<T extends object>(eventName: string, data?: T)` - инициализация события.
- `onAll(callback: (event: EmitterEvent) => void)` - подписка на все события.
- `offAll()` - сброс всех обработчиков.
- `trigger<T extends object>(eventName: string, context?: Partial<T>)` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие.

### Класс Component

Класс представляет собой абстрактный базовый компонент для создания пользовательского интерфейса. Он предоставляет основные методы для управления DOM-элементами, такие как отрисовка компонента, переключение классов, установка текста и изображений.

#### Конструктор класса принимает:

- `container: HTMLElement` - HTML-элемент, который будет использоваться как контейнер для компонента. Это обеспечивает базу для взаимодействия с DOM;

#### Класс предоставляет следующий набор методов:

- `render(data?: Partial<T>): HTMLElement` - используется для отображения компонента. Он может принимать необязательный параметр data, который позволяет обновить состояние компонента перед его отрисовкой. Возвращает корневой DOM-элемент компонента;
- `toggleClass(element: HTMLElement, className: string, force?: boolean)` - добавляет или удаляет CSS-класс у указанного элемента. Параметр force опциональный и может быть использован для принудительного добавления или удаления класса.
- `setText(element: HTMLElement, value: unknown)` - метод устанавливает текстовое содержимое для указанного элемента.
- `setDisabled(element: HTMLElement, state: boolean)` - изменяет статус блокировки элемента. Если state истинно, элемент будет заблокирован, иначе разблокирован.
- `setImage(element: HTMLImageElement, src: string, alt?: string)` - устанавливает источник изображения и альтернативный текст (опционально) для HTML-элемента изображения.

### Класс Model

Представляет собой абстрактный базовый класс, который определяет общую структуру и поведение моделей в приложении.

#### Конструктор класса принимает:

- `data: Partial<T>` - объект, который может содержать часть свойств типа T. Свойства из data копируются в экземпляр класса с помощью Object.assign;
- `events: IEvents` - брокер событий, который поддерживает интерфейс IEvents;

#### Метод, реализуемый классом:

- `emitChanges(event: string, payload?: object)` - метод используется для генерации событий об изменении модели. Принимает имя события event и опциональный параметр payload. Если payload не предоставлен, используется пустой метод. Вызывает функцию emit из объекта events, передавая ей event и payload.

## Классы представления

Классы представления отвечают за визуализацию соответствующих компонент приложения.

### Класс `Form`

Класс представляет собой форму, которая наследуется от `Component` и использует обобщенный тип `T` для работы с состоянием формы.

#### Свойства класса:

- `protected _submit: HTMLButtonElement;` - кнопка отправки формы.
- `protected _errors: HTMLElement;` - элемент отображения ошибок.
- `protected events: IEvents;` - объект для управления событиями.

Конструктор инициализирует контейнер формы, кнопку отправки, элемент ошибок и объект событий, а так же вызывает метод `initEventListeners`.

#### Методы:

- `private initEventListeners(): void` - данный метод добавляет слушатели событий для ввода данных и отправки формы.
- `private handleInputChange(evt: Event): void` - этот метод обрабатывает изменения ввода, извлекает имя поля и его значение, а затем вызывает метод `onInputChange`.
- `private handleSubmit(evt: Event): void` - метод предотвращает стандартное поведение отправки формы и генерирует событие отправки.
- `protected onInputChange(field: keyof T, value: string): void` - генерирует событие изменения поля ввода.
- `set valid(value: boolean)` - данный сеттер устанавливает состояние кнопки отправки в зависимости от валидности формы.
- `set errors(value: string)` - данный сеттер устанавливает текст ошибок.
- `render(state: Partial<T> & IFormState): HTMLFormElement` - данный метод рендерит состояние формы и обновляет ее элементы.

### Класс `Basket`

Данный класс представляет собой корзину покупок, которая наследуется от `Component` и использует интерфейс `IBaskeetView` для работы с представлением.

#### Свойства класса:

- `protected _list: HTMLElement;` - элемент списка в корзине.
- `protected _total: HTMLElement` - элемент отображения общей стоймости товаров.
- `protected _button: HTMLElement;` - кнопка для оформления заказа.
- `protected events: IEvents;` - объект для управления событиями.

Конструктор инициализирует контейнер корзины, элементы списка, общей стоймости и кнопки, а так же объект событий. Также добавляется обработчик события клика на кнопку для открытия доставки.

#### Методы:

- `private updateList(items: HTMLElement[])` - метод обновляет список товаров в корзине, заменяя элементы новыми.
- `private showEmptyMessage()` - метод отображает сообщение о пустой корзине, если в ней нет товаров.
- `private setButtonState(isDisabled: boolean)` - метод устанавливает состояние кнопки оформления заказа (активна/неактивна) в зависимости от наличия товаров в корзине.
- `set items(items: HTMLElement[])` - данный сеттер обновляет список товаров в корзине и состояние кнопки оформления заказа. Если корзина пуста, отображается сообщение о пустой корзине и кнопка деактивируется.
- `set total(total: number)` - этот сеттер обновляет отображаемую общую стоймость товаров в корзине.

### Класс `Modal`

Данный класс представляет собой модальное окно, которое наследуется от `Component` и использует интерфейс `IModalData` для работы с данными модального окна.

#### Свойства класса:

- `protected _closeButton: HTMLButtonElement;` - кнопка закрытия модального окна.
- `protected _content: HTMLElement;` - элемент отображения содержимого модального окна.
- `protected events: IEvents;` - объект для управления событиями.

Конструктор инициализирует контейнер модального окна, кнопку закрытия, элемент содержимого и объект событий. Также вызывается метод `initEventListeners` для установки слушателей событий.

#### Методы:

- `private initEventListeners(): void` - метод добавляет слушатели событий для закрытия модального окна при клике на контейнер или кнопку закрытия. Также предотвращается закрытие при клике на содержимое модального окна.
- `set content(value: HTMLElement)` - сеттер обновляет содержимое модального окна.
- `open():void` - метод открывает модальное окно, добавляя соответствующий CSS-класс и генерирует событие открытия.
- `close():void` - метод закрывает модальное окно, удаляя соответствующий CSS-класс, очищает содержимое и генерирует событие закрытия.
- `render(data: IModalData): HTMLElement` - метод рендерит данные модального окна и открывает его.

### Класс `Page`

Класс представляет собой страницу, которая наследуется от `Component` и использует интерфейс `IPage` для работы с данными страницы.

#### Свойства класса:

- `protected _catalog: HTMLElement;` - элемент, представляющий каталог товаров.
- `protected _basket: HTMLElement;` - корзина покупок.
- `protected _basketCounter: HTMLSpanElement;` - элемент, отображающий количество товаров в корзине.
- `protected _wrapper: HTMLDivElement;` - элемент-обертка для всей страницы.

Конструктор инициализирует контейнер страницы, элементы каталога, корзины, счетчика корзины и обертки. Также добавляется обработчик события клика на корзину.

#### Методы:

- `private handleBasketClick` - обрабатывает клик на корзину и генерирует событие открытия корзины.
- `set catalog(items: HTMLElement[])` - сеттер обновляет содержимое каталога, заменяя текущие элементы новыми.
- `set basketCounter(value: number)` - сеттер обновляет количество товаров в корзине, отображаемое в счетчике.
- `set locked(value: boolean)` - сеттер устанавливает состояние блокировки страницы, добавляя или удаляя соответствующий CSS-класс.

### Класс `ProductCard`

Класс представляет собой карточку товара, которая наследуется от `Component` и использует интерфейс `IProductCard` для работы с данными карточки товара.

#### Свойства класса:

- `protected _description?: HTMLParagraphElement;` - элемент для отображения описания товара.
- `protected _image?: HTMLImageElement;` - элемент для отображения изображения товара.
- `protected _title: HTMLHeadingElement;` - элемент для отображения названия товара.
- `protected _category: HTMLSpanElement;` - элемент для отображения категории товара.
- `protected _price: HTMLSpanElement;` - элемент для отображения цены товара.
- `protected _button?: HTMLButtonElement;` - кнопка для взаимодействия с товаром.
- `private categoryItem: Record<string, string>` - объект, содержащий категории товаров и CSS-классов для их отображения.

Конструктор инициализирует контейнер карточки товара, элементы карточки и события. Также вызываются методы `initElements` и `initEventListeners`.

#### Методы:

- `private initElements(container: HTMLElement): void` - инициализирует элементы карточки товара, такие как описание, изображение, название, категория, цена и кнопка.
- `private initEventListeners(actions: IProductCardActions): void` - добавляет слушатели событий для кнопки или контейнера карточки товара, если переданы соответствующие действия.
- `get id(): string` - геттер для идентификатора карточки товара.
- `set id(value: string)` - сеттер для идентификатора карточки товара.
- `set description(value: string)` - сеттер обновляет описание товара.
- `set image(value: string)` - сеттер обновляет изображение товара.
- `get title(): string` - геттер для названия товара.
- `set title(value: string)` - сеттер для названия товара.
- `get category(): string` - геттер для категории товара.
- `set category(value: string)` - сеттер для категории товара.
- `protected toggleCategory(value: string): void` - метод переключает CSS-класс категории товара в зависимости от значения.
- `get price(): number` - геттер для цены товара.
- `set price(value: number)` - сеттер для цены товара.
- `set button(value: string)` - сеттер обновляет текст кнопки.
- `setDisabledNonPriceButton(state: boolean)` - устанавливает состояние кнопки (активна/неактивна) в зависимости от того, есть цена у товара или она "Бесценна". Во втором случае, кнопка отключается, чтобы предотвратить добавление товара в корзину без цены.

### Класс `BasketProduct`

Класс представляет собой компонент товара в корзине, который наследуется от `Component` и использует интерфейс `IItemProductBasket` для работы с данными товара.

#### Свойства класса:

- `protected _title: HTMLHeadingElement;` - элемент для отображения названия товара.
- `protected _price: HTMLSpanElement;` - элемент для отображения цены товара.
- `protected _index: HTMLSpanElement;` - элемент для отображения индекса товара.
- `protected _deleteButton: HTMLButtonElement;` - кнопка для удаления товара из корзины.

Конструктор инициализирует контейнер товара, элементы названия, цены, индекса и кнопки удаления. Также добавляется обработчик события клика на кнопку удаления.

#### Методы:

- `handleDeleteClick` - обрабатывает клик на кнопку удаления и вызывает действие onClick, если оно определено.
- `set title(value: string)` - сеттер обновляет текст элемента **\_title**, отображая название товара.
- `set price(value: number)` - этот сеттер обновляет текст элемента **\_price**, отображая цену товара.
- `set index(value: number)` - этот сеттер обновляет текст элемента **\_index**, отображая индекс товара в корзине.
- `render(data: IItemProductBasket): HTMLElement` - рендерит данные товара и обновляет элементы карточки товара.

### Класс `Success`

Класс представляет собой компонент, отображающий сообщение об успешном завершении заказа. Он наследуется от `Component` и использует интерфейс `IOrderSuccess` для работы с данными успешного заказа.

#### Свойства класса:

- `protected _total: HTMLParagraphElement;` - элемент для отображения итоговой суммы списанных средств.
- `protected _closeButton: HTMLButtonElement;` - кнопка закрытия сообщения.

Конструктор инициализирует контейнер компонента, элемент для отображения общей суммы, кнопку закрытия и объект действий. Также добавляется обработчик события клика на кнопку закрытия.

#### Методы:

- `private handleCloseClick` - метод обрабатывает клик на кнопку закрытия и вызывает действие **onClick**, если оно определено.
- `set totalPrice(value: number)` - сеттер обновляет текст элемента **\_total**, отображая общую сумму списанных средств.

### Класс `DeliveryForm`

Класс представляет собой форму доставки, которая наследуется от `Form` и использует интерфейс `IDelivery` для работы с данными доставки.

#### Свойства класса:

- `protected _paymentButtons: HTMLDivElement;` - элемент, содержащий кнопки выбора способа оплаты.
- `protected _online: HTMLButtonElement;` - кнопка для выбора онлайн-оплаты.
- `protected _uponReceipt: HTMLButtonElement;` - кнопка для выбора оплаты при получении.
- `protected _address: HTMLInputElement;` - поле ввода адреса доставки.
- `protected events: IEvents;` - объект для управления событиями.

Конструктор инициализирует контейнер формы, элементы кнопок оплаты и объект событий. Также добавляется обработчик события клика на кнопки оплаты.

#### Методы:

- `private handlePaymentButtonClick` - обрабатывает клик на кнопки оплаты, устанавливает активный класс для выбранной кнопки и генерирует событие изменения способа оплаты.
- `setPaymentMethodClass(className: string): void` - устанавливает активный класс для кнопки оплаты в зависимости от выбранного способа.
- `get address()` - геттер для адреса доставки, который возвращает текущее значение адреса.
- `set address(value: string)` - сеттер для адреса доставки,который устанавливает новое значение.

### Класс `BuyerContactsForm`

Класс представляет собой удобный интерфейс для работы с формой контактных данных покупателя через соответствующие геттеры и сеттеры. Наследуется от `Form<IBuyerContacts>` и предназначен для работы с формой, содержащей контактные данные покупателя, такие как email и телефон.

#### Свойства класса:

- `protected _emailInput: HTMLInputElement;` - защищенное поле, содержащее элемент HTMLInputElement для ввода email.
- `protected _phoneInput: HTMLInputElement;` - защищенное поле, содержащее элемент HTMLInputElement для ввода телефона.

В конструкторе вызывается конструктор родительского класса, после чего инициализируются поля **\_emailInput** **\_phoneInput** с помощью функции **ensureElement**, которая находит соответствующие элементы в контейнере.

#### Методы:

- `get email(): string` - геттер, для получения значения email из поля ввода.
- `set email(value: string)` - сеттер, для установки значения email в поле ввода.
- `get phone()` - геттер для получения значения номера телефона из поля ввода.
- `set phone(value: string)` - геттер для установки значения номера телефона в поле ввода.

## Компоненты модели данных

### Класс `WebLarekApi`

Класс наследуется от `Api` и реализует интерфейс `IWebLarekApi`. Он предназначен для взаимодействия с API веб-приложения, предоставляя методы для получения списка продуктов, информацию о конкретном продукте и оформления заказа.

#### Свойства класса:

- `readonly cdn: string;` - строка, содержащая URL-адрес CDN (Content Delivery Network), который используется для получения изображений продуктов.

Конструктор принимает три параметра:

- `cdn` - URL-адрес CDN.
- `baseUrl` - базовый URL для API.
- `options` - необязательные параметры для инициализации запросов.
  В конструкторе вызывается конструктор родительского класса, после чего инициализируется поле cdn.

#### Методы:

- `getProductList(): Promise<IProductItem[]>` - метод, для получения списка продуктов.
- `getProductItem(id: string): Promise<IProductItem>` - метод для получения информации о конкретном продукте по его идентификатору.
- `orderProduct(order: TOrderData): Promise<IOrderSuccess>` - метод для оформления заказа.

### Класс `Product`

Класс наследуется от `Model<IProductItem>` и реализует интерфейс `IProductItem`. Он представляет собой моделть продукта с различными свойствами.

#### Свойства класса:

- `id: string;` - строка, идентификатор продукта.
- `description: string;` - строка, описание продукта.
- `image: string;` - строка, URL изображения продукта.
- `title: string;` - строка, название продукта.
- `category: string;` - строка, категория продукта.
- `price: number | null;` - число или null, цена продукта.
- `status: boolean;` - булево значение продукта.

---

### Класс `AppState`

Класс наследуется от `Model<IAppState>` и представляет состояние приложения. Он содержит данные о каталоге продуктов, корзине, заказе и другие состояния.

#### Свойства класса:

- `catalog: IProductItem[] = [];` - массив объектов IProductItem, представляющий собой каталог продуктов.
- `basket: IProductItem[] = [];` - массив объектов IProductItem, представляющий собой корзину покупок.
- `preview: string | null = null;` - строка или null, представляющая предварительный просмотр.
- `order: TOrderData;` - объект TOrderData, представляющий данные заказа.
- `loading: boolean = false;` - состояние загрузки.
- `formErrors: FormErrors = {};` - объект FormErrors, представляющий ошибки формы.

Конструктор принимает два параметра:

- `data: Partial<IAppState>` - частичные данные состояния приложения.
- `protected events: IEvents` - объект событий.

В конструкторе вызывается конструктор родительского класса, после чего инициализируется заказ с помощью метода **resetOrder**.

#### Методы:

- `resetOrder(): void` - метод для сброса данных заказа.
- `addProduct(item: IProductItem): void` - метод для добавления продукта в корзину.
- `deleteProduct(id: string): void` - метод для удаления продукта из корзины по его идентификатору.
- `setPaymentMethod(method: string): void` - метод для установки способа оплаты.
- `setAddress(value: string): void` - для установки адреса доставки.
- `setContactField(field: keyof IBuyerContacts, value: string): void` - для установки контактных данных покупателя.
- `setCatalog(items: IProductItem[]): void` - для установки каталога продуктов.
- `getOrderedProducts(): IProductItem[]` - для получения списка заказанных продуктов.
- `orderStatus(item: IProductItem): boolean` - для проверки статуса продукта в корзине.
- `clearBasket(): void` - для отчистки корзины.
- `getTotal(): number` - для получения общей суммы заказа.
- `orderSuccess(): void` - метод для завершения заказа.
- `validateDelivery(): void` - для валидации данных доставки.
- `validateBuyerContacts(): void` - для валидации данных покупателя.

## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.
